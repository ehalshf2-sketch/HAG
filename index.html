<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>連撃同時着弾計算機（5目的地・モードB専用）</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--text:#111827;--accent:#2563eb}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans JP,Noto Sans KR,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
.container{max-width:1000px;margin:0 auto;padding:18px}
h1{font-size:26px;margin:6px 0 14px;text-align:center}

/* Tabs */
.tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:12px}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;color:#111;font-weight:600;cursor:pointer}
.tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* Cards / layout */
.grid{display:grid; gap:16px}
@media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.section-title{font-weight:700;margin:6px 0 10px}
label{font-size:14px;margin-bottom:6px;display:block}
input,button{height:44px;border-radius:12px;border:1px solid var(--border);padding:0 12px;font-size:16px;width:100%}
input::placeholder{color:#9ca3af}
button{cursor:pointer}
.small{font-size:13px;color:var(--muted);margin-top:8px}

/* participants */
.part-row{display:grid;grid-template-columns:5fr 6fr 1fr;gap:8px;margin-top:8px}
.del{background:#fff;border-color:#ef4444;color:#ef4444}
.add{min-width:140px;margin-top:8px}

/* table */
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:16px}
th,td{padding:12px 8px;text-align:left;white-space:nowrap}
tbody tr{border-top:1px solid var(--border)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}

/* copy button */
.copy{min-width:160px;background:var(--accent);border-color:var(--accent);color:#fff;margin-top:12px}
</style>
</head>
<body>
  <div class="container">
    <h1>連撃同時着弾計算機（5目的地）</h1>

    <!-- Tabs -->
    <div class="tabs" id="tabs"></div>

    <div class="grid">
      <!-- 入力 -->
      <div class="card">
        <div class="section-title" id="panelTitle">設定</div>
        <label>集結時間（分）</label>
        <input id="rallyMinutes" value="5">

        <label style="margin-top:10px">目標着弾時刻（HH:MM:SS）</label>
        <input id="targetHit" placeholder="例: 13:30:00">

        <div class="section-title" style="margin-top:16px">参加者リスト</div>
        <div id="list"></div>
        <button id="addBtn" class="add">＋参加者追加</button>

        <div id="error" style="color:#dc2626;margin-top:8px;display:none"></div>
        <div class="small">※ 出発 = 目標着弾 − 集結時間（分） − 各自の移動時間</div>
      </div>

      <!-- 出力 -->
      <div class="card">
        <div class="section-title">計算結果</div>
        <table>
          <thead><tr><th>名前</th><th>移動（秒）</th><th>出発時刻</th><th>指示例</th></tr></thead>
        </table>
        <table>
          <tbody id="tbody"></tbody>
        </table>
        <button id="copyBtn" class="copy">指示文をコピー</button>
      </div>
    </div>
  </div>

<script>
/* ==== utils ==== */
let idSeed=1; const newId=()=>String(idSeed++);
const pad=(n)=>String(n).padStart(2,'0');
const isTime=(s)=>/^\d{1,2}:\d{2}:\d{2}$/.test((s||'').trim());
const parseHMS=(t)=>{const [h,m,s]=t.split(':').map(Number);return h*3600+m*60+s};
const fmtHMS=(t)=>{if(!isFinite(t))return'--:--:--';const sign=t<0?'-':'';t=Math.abs(Math.round(t));const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return `${sign}${pad(h)}:${pad(m)}:${pad(s)}`};
function parseTravel(s){s=(s||'').trim();if(/^\d+$/.test(s))return Number(s);if(/^\d{1,2}:\d{2}$/.test(s)){let[mm,ss]=s.split(':').map(Number);return mm*60+ss}if(isTime(s))return parseHMS(s);return NaN}

/* ==== state : 5 destinations ==== */
const DESTS=[
  { key:'east',  label:'東塔'  },
  { key:'west',  label:'西塔'  },
  { key:'south', label:'南塔'  },
  { key:'north', label:'北塔'  },
  { key:'castle',label:'王城'  },
];

const state={
  active:'east',
  pages:{
    east:  { title:'東塔',  rallyMinutes:5, targetHit:'', participants:[{id:newId(),name:'ザルコ',travel:'20'},{id:newId(),name:'ダウド',travel:'16'}]},
    west:  { title:'西塔',  rallyMinutes:5, targetHit:'', participants:[] },
    south: { title:'南塔',  rallyMinutes:5, targetHit:'', participants:[] },
    north: { title:'北塔',  rallyMinutes:5, targetHit:'', participants:[] },
    castle:{ title:'王城',  rallyMinutes:5, targetHit:'', participants:[] },
  }
};

/* ==== DOM ==== */
const tabsEl=document.getElementById('tabs');
const rallyMinutesEl=document.getElementById('rallyMinutes');
const targetHitEl=document.getElementById('targetHit');
const listEl=document.getElementById('list');
const tbodyEl=document.getElementById('tbody');
const errorEl=document.getElementById('error');
const addBtn=document.getElementById('addBtn');
const copyBtn=document.getElementById('copyBtn');
const panelTitle=document.getElementById('panelTitle');

/* ==== tabs ==== */
function renderTabs(){
  tabsEl.innerHTML='';
  DESTS.forEach(d=>{
    const b=document.createElement('button');
    b.className='tab'+(state.active===d.key?' active':'');
    b.textContent=d.label;
    b.onclick=()=>{ state.active=d.key; renderPage(); };
    tabsEl.appendChild(b);
  });
}

/* ==== participants list ==== */
function renderParticipants(){
  const page=state.pages[state.active];
  listEl.innerHTML='';
  page.participants.forEach(p=>{
    const row=document.createElement('div');
    row.className='part-row';
    row.innerHTML=`<input value="${p.name}">
                   <input value="${p.travel}" placeholder="20 / 1:20 / 00:01:20">
                   <button class="del">削除</button>`;
    const [nameInput, travelInput, delBtn]=row.children;
    nameInput.oninput=e=>{ p.name=e.target.value; renderTable(); };
    travelInput.oninput=e=>{ p.travel=e.target.value; renderTable(); };
    delBtn.onclick=()=>{ page.participants=page.participants.filter(x=>x.id!==p.id); renderParticipants(); renderTable(); };
    listEl.appendChild(row);
  });
}

/* ==== compute & table ==== */
function compute(page){
  const rallySec=Math.max(0,Math.round((Number(page.rallyMinutes)||0)*60));
  if(!isTime(page.targetHit)) return {ok:false,error:'目標着弾時刻を「HH:MM:SS」で入力してください'};
  const hit=parseHMS(page.targetHit);
  const rows=[];
  for(const p of page.participants){
    const sec=parseTravel(p.travel);
    if(!Number.isFinite(sec)) return {ok:false,error:'移動時間の形式を確認してください。「秒」または「MM:SS」または「HH:MM:SS」'};
    const start=hit-rallySec-sec;
    rows.push({name:p.name || '(名前なし)', travel:sec, startStr:fmtHMS(start)});
  }
  return {ok:true,rows};
}

function renderTable(){
  const page=state.pages[state.active];
  const res=compute(page);
  tbodyEl.innerHTML=''; errorEl.style.display='none';
  if(!res.ok){ errorEl.textContent=res.error; errorEl.style.display='block'; return; }
  res.rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.name}</td><td>${r.travel}</td><td class="mono">${r.startStr}</td><td class="mono">${r.name} ${r.startStr} 出発</td>`;
    tbodyEl.appendChild(tr);
  });
}

/* ==== main page render ==== */
function renderPage(){
  renderTabs();
  const page=state.pages[state.active];
  panelTitle.textContent=`設定（${page.title}）`;
  rallyMinutesEl.value=page.rallyMinutes;
  targetHitEl.value=page.targetHit;
  renderParticipants();
  renderTable();
}

/* ==== events ==== */
rallyMinutesEl.oninput=e=>{ state.pages[state.active].rallyMinutes=e.target.value; renderTable(); };
targetHitEl.oninput=e=>{ state.pages[state.active].targetHit=e.target.value; renderTable(); };
addBtn.onclick=()=>{ state.pages[state.active].participants.push({id:newId(),name:`参加者${state.pages[state.active].participants.length+1}`,travel:''}); renderParticipants(); renderTable(); };
copyBtn.onclick=()=>{
  const page=state.pages[state.active];
  const res=compute(page); if(!res.ok) return;
  const lines=[`${page.title} / 目標着弾: ${page.targetHit} / 集結 ${Math.round((Number(page.rallyMinutes)||0))}分`,''];
  res.rows.forEach(r=>lines.push(`${r.name} → ${r.startStr} 出発 (移動 ${r.travel}秒)`));
  navigator.clipboard.writeText(lines.join('\n'));
  alert('指示文をコピーしました。');
};

/* init */
renderPage();
</script>
</body>
</html>
